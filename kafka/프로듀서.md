### 토픽에 메세지 전송
프로듀서를 사용해서 메세지를 보내는 코드
![스크린샷 2023-01-10 오후 8.20.24.png](images%2F%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202023-01-10%20%EC%98%A4%ED%9B%84%208.20.24.png)
Properties를 이용해서 프로듀서가 사용할 속성을 지정한다.(설정정보이다.)

이 설정 정보에는 브로커 목록이나, 키, value를 직렬화할 때 사용할 serializer.
그 외에는 ack, batchSize를 설정한다.

카프카 producer객체는 send메서드를 제공한다.
이 send 메서드에 producer레코드를 전달하고, 이 레코드가 이것이 카프카 브로커에 전송할 메세지가 된다.

프로듀서 레코드는 크게 두 가지 방법으로 생성할 수 있다.
- 토픽 이름과 key, value를 사용해서 생성하는 것
- 토픽 이름과 value만 사용해서 생성하는 것

프로듀서를 다 사용했다면, close메서드를 이용해서 닫아주면 된다.

### 프로듀서의 기본 흐름
![스크린샷 2023-01-10 오후 8.24.01.png](images%2F%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202023-01-10%20%EC%98%A4%ED%9B%84%208.24.01.png)
send랑 Sender가 별도의 스레드로 동작하기 때문에 서로에게 영향을 주지 않는다.
send를 통해 배치에 메세지를 게속 쌓고, 이와 별도로 Sender도 브로커로 배치를 전송하게 된다.

### 처리량 관련 주요 속성
- batchSize: 배치 크기. 배치가 다 차면 바로 전송한다.
- linger.ms: 전송 대기 시간. 대기 시간이 없으면 배치를 바로 전송하고, 대기 시간을 주면 그 시간만큼 기다렸다가 배치를 전송한다.

### 전송 결과 확인 안함
![스크린샷 2023-01-10 오후 8.37.33.png](images%2F%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202023-01-10%20%EC%98%A4%ED%9B%84%208.37.33.png)

### 전송 결과 확인함: Future 사용
![스크린샷 2023-01-10 오후 8.37.48.png](images%2F%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202023-01-10%20%EC%98%A4%ED%9B%84%208.37.48.png)
만약 전송 결과를 확인해야 하면, 반환타입인 Future를 사용해야 한다.
하지만 Future의 get메서드는 블로킹하기 때문에, 하나의 메세지를 보내고 블로킹되고 또 하나를 보내고 블로킹 되는 식으로 동작하기 때문에
배치에 메세지가 한개씩만 들어가게 되기 때문에 처리량이 저하된다.

하지만 건별로 확실하게 결과를 알 수 있긴 하다. 그래서 처리량이 낮더라도 꼭 확인해야 할 때 사용한다.

### 전송 결과 확인함: Callback 사용
![스크린샷 2023-01-10 오후 8.39.39.png](images%2F%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202023-01-10%20%EC%98%A4%ED%9B%84%208.39.39.png)
Callback은 전송이 완료되면 onCompletion메서드로 받게 되는데, 이때 exception객체를 받게 되면 전송에 실패한 것이다.
그래서 전송에 성공했냐, 실패했냐에 따라서 알맞은 후처리가 가능하다.

이 방식은 블로킹하지 않기 때문에, 배치가 쌓이지 않는다거나 하는 단점이 사라지니 처리량의 저하를 발생시키지 않는다.

### 전송 보장과 ack
프로듀서는 전송을 보장하기 위해서 ack 설저을 사용하게 된다. 
ack 값이 0이면 서버로부터 성공 실패 응답을 기다리지 않는다.
즉, 전송을 보장하지 않는다. ack가 0이면 처리량은 많이 높아지겠지만, 메세지가 유실되어도 실패 여부를 알 수 없기 때문에 전송 여부가 중요한 경우에는 ack 0을 사용하면 안된다.

ack가 1이면 파티션을 리더에 저장하게 되면 성공 응답을 받게 된다. 하지만 그래서 리더의 장애가 발생하면 메세지가 유실될 가능성이 있다.
리더에 성공적으로 저장이 돼서 성공 응답을 받았는데, 그 상태에서 아직 팔로워에는 저장이 되지 않고 리더가 장애가 났다면
기존 리더의 저장됐던 메세지가 사자리게 된다.
그래서 엄격하게 전송을 보장해야 하는 상황에서는 ack값을 all로 지정하게 된다.
all은 모든 리플리카에 저장됐을 때 성공응답을 받게 된다.


![Pasted image 20230110213222.png](images%2FPasted%20image%2020230110213222.png)